<!DOCTYPE html>
<html lang="en">
<head>
<title>Memecached</title>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="/nowjs/now.js"></script>
<link rel="stylesheet" type="text/css" href="http://dl.dropbox.com/u/40496552/bootstrap.css"/>

<style>
.resized {
    height: 300px;
    width: 300px;
    padding: 10px 10px;
}
</style>

<script>

memeName = "Y U NO Guy";
width = 300;
height = 300;

$(document).ready(function(){
    
    makeCanvas = function(doc) {
        return ("<canvas class = 'resized' id = '" + doc._id + "'></canvas>");
    }
    
    drawText = function(context, pos, text) {
        var fontSize = 100;
        while(1) {
            context.font = "bold " + fontSize + "px Arial";
            if( (context.measureText(text).width < (width-15)) && (fontSize < height/10) ) {
                break;
            }
            fontSize-=2;
        }
       
        var y;
        if(pos == "top")
            y = fontSize;
        else if(pos == "bottom") {
            y = height/2 - fontSize/2;
        }
         
        context.strokeText(text, width/2, y);
        context.fillText(text, width/2, y); 
    }

    updateList = function(doc, where) {
        if(where == "top")
            $("#meme-list").prepend(makeCanvas(doc));
        $("#meme-list").append(makeCanvas(doc));
        var canvas = document.getElementById(doc._id);
        var context = canvas.getContext("2d");
        context.textAlign = "center";
        context.fillStyle = "#fff";
        context.strokeStyle = "#000";
        context.lineWidth = 3;

        var img = new Image();
        img.src = "http://dl.dropbox.com/u/40496552/" + doc.name + ".jpeg";
        img.onload = function() {
            context.drawImage(img, 0, 0, canvas.width, canvas.height);
            drawText(context, "top", doc.text.line1);
            drawText(context, "bottom", doc.text.line2);
        };
    }

    now.getContent = function(docs) {
        docs.forEach(updateList);
    }
  
    now.receiveMeme = function(doc) {
        updateList(doc, "top");
    }

    $("#publish-button").click(function(){
        var meme = {
            name: memeName,
            text: {
                line1: $("#text-input1").val().toUpperCase(),
                line2: $("#text-input2").val().toUpperCase()
            }
        };

        now.publish(meme);

        $("#text-input1").val("");
        $("#text-input2").val("");
    });
    
    now.ready( function() {
        now.getRecent();
    });
});

</script>
</head>

<body>

<h1> Memecached </h1>

<div>
<input type="text" id="text-input1" style="text-transform: uppercase;">
<input type="text" id="text-input2" style="text-transform: uppercase;">
<input type="button" value="Publish" id="publish-button">
</div>


<div id="meme-list"></div>


</body>
</html>
